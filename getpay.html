<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout – Java Mastery Course (GetPay Test)</title>
  <meta name="description" content="Test checkout integration using GetPay UAT / test bundle">

  <!-- NOTE: We dynamically load your test bundle via JS so we can detect load / errors -->
  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --primary:#5662FF; --primary-dark:#3e4dcc; --text:#1a1a2e; --gray:#94a3b8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(135deg,#f5f7ff 0%,#e6e9ff 100%);
      color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .container{background:#fff;max-width:480px;width:100%;border:1px solid #e2e8f0;border-radius:20px;overflow:hidden;
      box-shadow:0 20px 40px rgba(86,98,255,0.12);}
    .header{background:linear-gradient(135deg,var(--primary),#7b85ff);color:#fff;padding:28px 20px;text-align:center}
    .header h1{font-size:26px;font-weight:700;margin-bottom:6px}
    .header p{opacity:.92}
    .content{padding:24px}
    .course-card{display:flex;align-items:center;background:#f8f9ff;border-radius:12px;padding:12px;margin-bottom:20px;border:1px solid #e6eaff}
    .course-card img{width:80px;height:80px;object-fit:cover;border-radius:10px;margin-right:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
    .course-info h3{font-size:18px;margin-bottom:6px}
    .price{font-size:22px;font-weight:700;color:var(--primary)}
    .btn-pay{width:100%;padding:14px 16px;font-size:16px;font-weight:600;background:var(--primary);color:#fff;border:0;border-radius:12px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;transition:all .18s ease}
    .btn-pay:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(86,98,255,0.18);background:var(--primary-dark)}
    .btn-pay:disabled{background:#94a3b8;cursor:not-allowed;transform:none}
    .secure-note{text-align:center;margin-top:14px;font-size:13px;color:var(--gray)}
    .loader-inline { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.25); border-top-color: #fff; border-radius:50%; animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width:480px){ .header h1{font-size:20px} .course-card{flex-direction:column;text-align:center} .course-card img{margin-bottom:12px;margin-right:0} }
    .status { margin-top:12px; text-align:center; font-size:13px; color:#6b7280; }
    .status.warn { color: #b45309; }
    .status.err { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="header">
      <h1>Java Mastery Course (Test)</h1>
      <p>UAT GetPay integration — test mode</p>
    </div>

    <div class="content">
      <div class="course-card">
        <img alt="Java Course" src="https://sandeepkumarjha.com.np/img/java.png">
        <div class="course-info">
          <h3>JAVA FULL COURSE</h3>
          <div class="price">Rs 4,500</div>
        </div>
      </div>

      <button id="checkout-btn" class="btn-pay" type="button" aria-live="polite">
        <i class="fas fa-lock"></i>
        <span id="btn-text">Proceed to Pay Securely</span>
      </button>

      <p class="secure-note">
        <i class="fas fa-shield-alt"></i> Secured by NCHL GetPay • 256-bit SSL Encryption
      </p>

      <div id="integration-status" class="status" aria-hidden="false">Loading payment SDK…</div>
    </div>
  </div>

  <!-- Hidden container in case SDK wants an element -->
  <div id="checkout-container" hidden></div>

  <script>
  /***********************************************************************
   * Test credentials & endpoints (exact values you provided)
   ***********************************************************************/
  const TEST_CONFIG = {
    PAP_INFO: "eyJpbnN0aXR1dGlvbklkIjoiMTIyIiwibWlkIjoiMTIzMTIzNDUxNzcwOTg2IiwidGlkIjoiMTIzNTg3NjIifQ==",
    OPR_KEY: "4fa4c6b9-3f91-43e5-9b4f-319f68187ba5",
    INS_KEY: "", // intentionally empty
    TEST_BUNDLE: "https://minio.finpos.global/getpay-cdn/webcheckout/v5/bundle.js",
    BASE_URL: "https://uat-bank-getpay.nchl.com.np/ecom-web-checkout/v1/secure-merchant/transactions",
    WEBSITE_DOMAIN: "https://sandeepkumarjha.com.np"
  };

  /***********************************************************************
   * Utility: dynamically load SDK script with timeout and robust detection
   ***********************************************************************/
  function loadScriptWithTimeout(src, opts = {}) {
    const timeoutMs = opts.timeoutMs || 12000;
    return new Promise((resolve, reject) => {
      // If script already present and loaded, resolve
      const existing = Array.from(document.getElementsByTagName('script')).find(s => s.src && s.src.indexOf(src) !== -1);
      if (existing) {
        if (existing.getAttribute('data-getpay-ready') === 'true') return resolve(existing);
        // if already exists but not marked, wait for load/error events
        existing.addEventListener('load', () => resolve(existing));
        existing.addEventListener('error', (e) => reject(new Error('Existing script failed to load')));
        return;
      }

      const script = document.createElement('script');
      script.src = src;
      script.async = true; // allow parallel loading but we check readiness explicitly
      script.crossOrigin = "anonymous";
      script.addEventListener('load', () => {
        script.setAttribute('data-getpay-ready','true');
        resolve(script);
      });
      script.addEventListener('error', (e) => {
        reject(new Error('Script failed to load: ' + src));
      });
      document.head.appendChild(script);

      // timeout
      setTimeout(() => {
        reject(new Error('Timed out loading script: ' + src));
      }, timeoutMs);
    });
  }

  /***********************************************************************
   * Detect SDK global name and return "factory" or constructor
   * We attempt multiple known global names to maximize compatibility.
   ***********************************************************************/
  function detectGetPayFactory() {
    // Common variations we've seen in vendor bundles
    const candidates = [
      window.GetPay,
      window.GetPayCheckout,
      window.getpay,
      window.GetPayClient,
      window.Getpay, // case variants
      window.getPay,
      window.GetPayWebCheckout
    ];

    for (const c of candidates) {
      if (!c) continue;
      if (typeof c === 'function' || typeof c === 'object') {
        return c;
      }
    }
    // Additionally, some bundles attach to window.getpay && window.getpay.checkout
    if (window.getpay && (typeof window.getpay.checkout === 'function' || typeof window.getpay.init === 'function')) {
      return window.getpay;
    }
    return null;
  }

  /***********************************************************************
   * Main initialization flow
   ***********************************************************************/
  (function () {
    const statusEl = document.getElementById('integration-status');
    const btn = document.getElementById('checkout-btn');
    const btnText = document.getElementById('btn-text');
    let sdkReady = false;

    // Helper to update UI state
    function setStatus(text, cls = '') {
      statusEl.textContent = text;
      statusEl.className = 'status' + (cls ? ' ' + cls : '');
    }

    // Load the provided test bundle, then detect SDK
    loadScriptWithTimeout(TEST_CONFIG.TEST_BUNDLE, { timeoutMs: 12000 })
      .then(() => {
        // small delay to allow bundle to attach any globals
        return new Promise(res => setTimeout(res, 150));
      })
      .then(() => {
        const factory = detectGetPayFactory();
        if (!factory) {
          // SDK didn't expose expected globals (adblock or wrong bundle)
          setStatus('Payment SDK loaded but no GetPay global found. Check console for details.', 'warn');
          console.error('[GetPay] SDK loaded but could not find export. Globals:', {
            GetPay: window.GetPay,
            GetPayCheckout: window.GetPayCheckout,
            getpay: window.getpay,
            GetPayClient: window.GetPayClient,
            GetPayWebCheckout: window.GetPayWebCheckout
          });
          // still allow clicking to show meaningful error
          sdkReady = false;
          return;
        }
        // mark ready
        sdkReady = true;
        setStatus('Payment SDK ready (test bundle).');
        console.info('[GetPay] detected SDK factory/global:', factory);
      })
      .catch((err) => {
        console.error('[GetPay] Failed to load SDK bundle:', err);
        setStatus('Failed to load payment SDK. Please disable adblock or allow third-party scripts and refresh.', 'err');
      });

    /***********************************************************************
     * Button click: create checkout instance with your test credentials
     * and attempt to open/start the checkout using common method names.
     ***********************************************************************/
    btn.addEventListener('click', async function onPayClick(e) {
      e.preventDefault();
      const button = this;
      if (button.disabled) return;
      button.disabled = true;
      btnText.innerText = 'Processing…';
      const spinner = document.createElement('span');
      spinner.className = 'loader-inline';
      // ensure spinner visible next to text
      button.prepend(spinner);

      // Wait a tiny bit if the SDK is still loading
      const maxWaitMs = 6000;
      const pollInterval = 150;
      let waited = 0;
      while (!detectGetPayFactory() && waited < maxWaitMs) {
        await new Promise(r => setTimeout(r, pollInterval));
        waited += pollInterval;
      }

      const factory = detectGetPayFactory();
      if (!factory) {
        // final fallback: inform user & re-enable UI
        setStatus('Payment SDK not available. Open console for details.', 'err');
        console.error('[GetPay] SDK not available after waiting. Current globals:', {
          GetPay: window.GetPay, GetPayCheckout: window.GetPayCheckout, getpay: window.getpay
        });
        button.disabled = false;
        btnText.innerText = 'Proceed to Pay Securely';
        spinner.remove();
        return;
      }

      // Build options according to your inputs and common SDK expectation
      const options = {
        papInfo: TEST_CONFIG.PAP_INFO,
        oprKey: TEST_CONFIG.OPR_KEY,
        insKey: TEST_CONFIG.INS_KEY,
        baseUrl: TEST_CONFIG.BASE_URL, // test base URL
        websiteDomain: TEST_CONFIG.WEBSITE_DOMAIN,
        price: 4500.00,
        currency: "NPR",
        businessName: "Sandeep Store - Learn Smart",
        clientRequestId: "ORDER001-JAVA-" + Date.now(),
        imageUrl: "https://sandeepkumarjha.com.np/img/java.png",
        containerId: "checkout-container",
        callbackUrl: {
          successUrl: TEST_CONFIG.WEBSITE_DOMAIN + "/payment.html",
          failUrl: TEST_CONFIG.WEBSITE_DOMAIN + "/fail.html"
        },
        userInfo: {
          name: "Sandeep Kumar Jha",
          email: "sandeep@example.com",
          state: "Bagmati",
          country: "Nepal",
          zipcode: "44600",
          city: "Kathmandu",
          address: "Maitidevi"
        },
        prefill: {
          name: true, email: true, state: true, city: true, address: true, zipcode: true, country: true
        },
        disableFields: { address: true, state: true },
        themeColor: "#5662FF",
        orderInformationUI: `
          <div style="font-family:Inter,Arial,sans-serif;padding:12px;background:#f8f9ff;border-radius:10px;">
            <strong>JAVA MASTERY COURSE</strong><div style="margin-top:6px;color:#5662FF;font-weight:700">Rs 4,500.00</div>
          </div>`
      };

      try {
        // Try common ways vendors expose SDK factories:
        // 1) constructor function (new GetPay(options))
        // 2) factory function that returns instance (GetPayCheckout(options))
        // 3) namespaced API (window.getpay.init(options))
        let instance = null;
        const sdk = detectGetPayFactory();

        if (typeof sdk === 'function') {
          // try constructor
          try {
            instance = new sdk(options);
            console.info('[GetPay] created via `new`');
          } catch (innerErr) {
            // try as factory function
            try {
              instance = sdk(options);
              console.info('[GetPay] created via factory call');
            } catch (fErr) {
              console.warn('[GetPay] factory call failed', fErr);
            }
          }
        } else if (typeof sdk === 'object' && sdk !== null) {
          // e.g. window.getpay with methods
          if (typeof sdk.init === 'function') {
            instance = sdk.init(options);
            console.info('[GetPay] initialized via getpay.init()');
          } else if (typeof sdk.checkout === 'function') {
            instance = sdk.checkout(options);
            console.info('[GetPay] initialized via getpay.checkout()');
          } else {
            // pass-through object, keep as instance
            instance = sdk;
          }
        }

        // If instance wasn't created above, try to use well-known global directly
        if (!instance) {
          if (window.GetPay) {
            try { instance = new window.GetPay(options); console.info('[GetPay] used window.GetPay'); } catch (e) { console.warn(e) }
          }
          if (!instance && window.GetPayCheckout) {
            try { instance = window.GetPayCheckout(options); console.info('[GetPay] used window.GetPayCheckout'); } catch (e) { console.warn(e) }
          }
        }

        if (!instance) {
          throw new Error('Could not create GetPay checkout instance — SDK API mismatch.');
        }

        // Try opening the checkout using common methods
        if (typeof instance.open === 'function') {
          instance.open();
          console.info('[GetPay] called instance.open()');
          setStatus('Checkout opened — follow the payment UI.');
        } else if (typeof instance.initialize === 'function') {
          await instance.initialize();
          // some SDKs require explicit open afterwards
          if (typeof instance.open === 'function') instance.open();
          setStatus('Checkout initialized.');
          console.info('[GetPay] used initialize() then open() if available.');
        } else if (typeof instance.init === 'function') {
          await instance.init();
          if (typeof instance.open === 'function') instance.open();
          setStatus('Checkout initialized.');
          console.info('[GetPay] used init() then open() if available.');
        } else {
          // Last attempt: if the factory returned an object that exposes a `start` method or `launch`
          if (typeof instance.start === 'function') {
            instance.start();
            setStatus('Checkout started.');
            console.info('[GetPay] called instance.start()');
          } else if (typeof instance.launch === 'function') {
            instance.launch();
            setStatus('Checkout launched.');
            console.info('[GetPay] called instance.launch()');
          } else {
            throw new Error('No known method on the GetPay instance to open the checkout UI.');
          }
        }

      } catch (err) {
        console.error('[GetPay] checkout init/open error:', err);
        setStatus('Payment initialization failed. See console for details.', 'err');
        alert('Payment initialization failed. Please check the console for details and ensure the test bundle is allowed.');
      } finally {
        // leave the button disabled while the checkout UI is in control; if you want to re-enable,
        // you could add logic in success/fail callbacks to re-enable or redirect.
        spinner.remove();
        btnText.innerText = 'Proceed to Pay Securely';
        // do NOT automatically re-enable button; checkout UI may handle navigation
      }
    });
  })();
  </script>
</body>
</html>
