<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GetPay Test Checkout</title>

    <!-- Load GetPay Bundle FIRST -->
    <script src="https://minio.finpos.global/getpay-cdn/webcheckout/v5/bundle.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
        }
        button {
            padding: 14px 26px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <h2>GetPay WebCheckout v5 â€“ Test Demo</h2>
    <button id="payBtn">Pay with GetPay</button>

    <script>
        /************************************************************
         * 1) CONFIGURATION (YOUR TEST CREDS)
         ************************************************************/
        const PAP_INFO = "eyJpbnN0aXR1dGlvbklkIjoiMTIyIiwibWlkIjoiMTIzMTIzNDUxNzcwOTg2IiwidGlkIjoiMTIzNTg3NjIifQ==";
        const OPR_KEY = "4fa4c6b9-3f91-43e5-9b4f-319f68187ba5";
        const BASE_URL = "https://uat-bank-getpay.nchl.com.np/ecom-web-checkout/v1/secure-merchant/transactions";

        /************************************************************
         * 2) LOAD CHECK: WAIT UNTIL GetPayCheckout IS READY
         ************************************************************/
        function waitForGetPaySDK(maxAttempts = 40, interval = 250) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const timer = setInterval(() => {
                    if (window.GetPayCheckout) {
                        clearInterval(timer);
                        resolve(true);
                    }
                    attempts++;
                    if (attempts >= maxAttempts) {
                        clearInterval(timer);
                        reject("SDK not loaded");
                    }
                }, interval);
            });
        }

        /************************************************************
         * 3) API: CREATE TRANSACTION
         ************************************************************/
        async function createTransaction() {
            const payload = {
                amount: 100,               // Rs 100
                currency: "NPR",
                purchaseDescription: "Test Payment",
                papInfo: PAP_INFO,
                merchantTxnId: "TXN" + Date.now(),
                successUrl: "https://example.com/success",
                failureUrl: "https://example.com/failure"
            };

            const response = await fetch(BASE_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "oprKey": OPR_KEY
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error("Transaction creation failed");
            }

            return await response.json();
        }

        /************************************************************
         * 4) LAUNCH THE GETPAY CHECKOUT POPUP
         ************************************************************/
        async function startCheckout() {
            try {
                console.log("[GetPay] Waiting for SDK...");
                await waitForGetPaySDK();

                console.log("[GetPay] SDK Loaded:", window.GetPayCheckout);

                const txn = await createTransaction();
                console.log("[GetPay] TXN Response:", txn);

                const checkout = new GetPayCheckout({
                    token: txn.token,                 // Required token from API
                    onSuccess: function (res) {
                        console.log("Payment Success:", res);
                        alert("Payment Successful!");
                    },
                    onFailure: function (err) {
                        console.error("Payment Failed:", err);
                        alert("Payment Failed!");
                    },
                    onClose: function () {
                        console.log("Checkout Closed");
                    }
                });

                checkout.open(); // Open the widget
            } catch (error) {
                console.error("[GetPay] ERROR:", error);
                alert("Error: " + error);
            }
        }

        /************************************************************
         * 5) BUTTON CLICK EVENT
         ************************************************************/
        document.getElementById("payBtn").addEventListener("click", startCheckout);
    </script>
</body>
</html>
